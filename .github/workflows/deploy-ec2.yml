name: Deploy app to EC2

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-south-1
  DOCKER_IMAGE_NAME: terraform-ec2-lab

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------- Docker build & push ----------

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # ---------- Terraform: make sure EC2 exists ----------

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Apply (ensure EC2 up-to-date)
        working-directory: ./terraform
        run: terraform apply -auto-approve -var="docker_image=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"

      # ---------- Get instance details from Terraform state ----------

      - name: Get instance ID and public IP
        id: tf_outputs
        working-directory: ./terraform
        run: |
          INSTANCE_ID=$(terraform output -raw ec2_instance_id)
          PUBLIC_IP=$(terraform output -raw ec2_public_ip)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "Instance ID: $INSTANCE_ID"
          echo "Public IP: $PUBLIC_IP"

      # ---------- Start EC2 if stopped ----------

      - name: Start EC2 instance (if it is stopped)
        run: |
          echo "Starting instance $INSTANCE_ID (if needed)..."
          aws ec2 start-instances --instance-ids "$INSTANCE_ID" >/dev/null 2>&1 || true
          echo "Waiting for instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids "$INSTANCE_ID"
          echo "Instance is ready."

      # ---------- Use SSM to deploy latest Docker image ----------

      - name: Deploy latest Docker image via SSM
        run: |
          DOCKER_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"

          echo "Sending SSM command to deploy image $DOCKER_IMAGE on $INSTANCE_ID"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy latest Docker image" \
            --parameters '{
              "commands": [
                "sudo systemctl start docker || true",
                "sudo docker pull '"$DOCKER_IMAGE"'",
                "sudo docker stop webapp || true",
                "sudo docker rm webapp || true",
                "sudo docker run -d --name webapp -p 80:80 '"$DOCKER_IMAGE"'"
              ]
            }' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM command ID: $COMMAND_ID"

          # Optionally wait for command completion
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"

          echo "Deployment command finished."

      - name: Show public URL
        run: |
          echo "================================================================"
          echo " Deployment complete."
          echo " Open this URL in your browser to test the app:"
          echo "   http://$PUBLIC_IP"
          echo "================================================================"
